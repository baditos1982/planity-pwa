
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planity v1.2 ¬∑ Dashboard</title> <!-- Versi√≥n actualizada en el t√≠tulo del navegador -->
    <meta name="theme-color" content="#f5f7fb">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PWA: Link to manifest.json -->
    <link rel="manifest" href="./manifest.json">

    <style>
        :root {
            --bg: #f5f7fb; /* Light background */
            --card: #ffffff; /* White cards */
            --soft: #e0e2e6; /* Light gray for controls */
            --txt: #1a1a1a; /* Dark text principal */
            --muted: #6b7280; /* Muted gray for secondary text */
            --brand: #F4D00C; /* LEGIPOL yellow */
            --blue: #007aff; /* iOS blue for active active states */
            --ok: #34c759; /* iOS green for check */
            --danger: #ff3b30; /* iOS red */
            --shadow: 0 4px 12px rgba(0,0,0,.08); /* Lighter, softer shadow */
            --radius: 18px;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: linear-gradient(140deg, #f0f2f5, #ffffff 30%, #f5f7fb); color: var(--txt); font: 16px 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, system-ui, Arial, sans-serif; }
        .app { max-width: 920px; margin: 0 auto; padding: 20px; }

        /* ---- OPTIMIZACI√ìN M√ìVIL Y TABLET (Mobile-first) ---- */
        .app {
            padding: 10px; /* Padding reducido por defecto para m√≥viles */
        }
        header {
            flex-wrap: wrap; /* Permitir que los elementos del encabezado se envuelvan */
            justify-content: center; /* Centrar los elementos cuando se envuelven */
            text-align: center; /* Centrar el texto en los elementos envueltos */
        }
        header > div {
            width: 100%; /* Asegurar que el div de fecha/t√≠tulo ocupe todo el ancho */
        }
        .topbar {
            margin-top: 12px; /* A√±adir espacio cuando la barra de d√≠as se mueve abajo */
            justify-content: center; /* Centrar la barra de d√≠as horizontalmente */
            width: 100%; /* Asegurar que ocupe todo el ancho disponible */
        }
        .title {
            font-size: 24px; /* Ajustar el tama√±o del t√≠tulo para m√≥viles */
        }
        .grid {
            grid-template-columns: 1fr; /* Una columna por defecto en m√≥viles */
        }
        .chart-controls {
            flex-direction: column; /* Apilar controles de gr√°fica en m√≥vil */
            align-items: flex-start;
        }
        .chart-controls label {
            width: 100%; /* Checkboxes y select ocupan todo el ancho */
            justify-content: space-between;
        }
        .chart-controls select {
             width: auto; /* Dejar que el select se ajuste a su contenido */
        }


        @media (min-width: 480px) { /* Small tablets, larger phones */
            .app {
                padding: 15px;
            }
            .grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Permitir 1 o 2 columnas */
            }
            .chart-controls {
                flex-direction: row; /* Volver a fila en tablets */
                justify-content: center;
                align-items: center;
            }
            .chart-controls label {
                width: auto; /* Restablecer ancho para checkboxes */
                justify-content: flex-start;
            }
        }

        @media(min-width:768px) { /* Tablets grandes, algunos port√°tiles */
            .app {
                padding: 20px;
            }
            .grid {
                grid-template-columns: repeat(2, 1fr); /* 2 columnas */
            }
            .grid > section.full-width-card { /* Para tarjetas que ocupan todo el ancho */
                grid-column: span 2;
            }
        }
        @media(min-width:1024px) { /* Escritorios */
            .grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columnas */
            }
            .grid > section.full-width-card { /* Para tarjetas que ocupan todo el ancho */
                grid-column: span 3;
            }
            header {
                flex-wrap: nowrap;
                justify-content: space-between;
                text-align: left;
            }
            header > div {
                width: auto;
            }
            .topbar {
                margin-top: 0;
                width: auto;
            }
            .title {
                font-size: 28px;
            }
        }
        /* ---- FIN DE OPTIMIZACI√ìN M√ìVIL Y TABLET ---- */


        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .title { font-weight: 800; letter-spacing: .2px; color: var(--txt); }
        .badge { font-size: 12px; color: var(--muted); }
        .card { background: var(--card); border: 1px solid rgba(0,0,0,.08); backdrop-filter: saturate(120%) blur(6px); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }
        .grid {
            display: grid;
            gap: 12px;
        }

        .topbar { display: flex; gap: 10px; align-items: center; }
        .seg {
            display: flex;
            background: var(--soft);
            border-radius: 14px;
            padding: 4px;
            overflow-x: auto; /* Permite el scroll horizontal si los elementos exceden el ancho */
            -webkit-overflow-scrolling: touch; /* Suaviza el scroll en iOS */
            white-space: nowrap; /* Mantiene los botones en una sola l√≠nea */
            flex-shrink: 0; /* Evita que la barra se encoja */
            max-width: 100%; /* Asegura que no se desborde del contenedor principal */
        }
        .seg::-webkit-scrollbar {
            display: none; /* Oculta la barra de scroll en navegadores WebKit (Chrome, Safari) */
        }
        .seg button {
            border: 0;
            background: transparent;
            color: var(--muted);
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Smoother transition */
            flex-shrink: 0; /* Evita que los botones se encojan */
        }
        .seg button.active { background: var(--blue); color: white; box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3); }
        .progress { height: 10px; background: #e0e2e6; border-radius: 999px; overflow: hidden; }
        .progress > span { display: block; height: 100%; background: linear-gradient(90deg, var(--brand), #ffd84d); width: 0%; transition: width 0.5s ease-out; }
        .row { display: flex; gap: 10px; align-items: center; }
        .meal { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; background-color: var(--card); border: 1px solid rgba(0,0,0,.08); border-radius: var(--radius); padding: 12px; transition: all 0.2s ease-in-out; }
        .meal:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .meal-header { display: flex; align-items: center; gap: 12px; width: 100%; }
        .meal .check {
            width: 22px; height: 22px; border-radius: 8px; border: 1px solid var(--muted);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            flex-shrink: 0;
            background-color: transparent;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .meal .check svg { width: 16px; height: 16px; fill: white; display: none; }
        .meal.done .check { background-color: var(--ok); border-color: var(--ok); }
        .meal.done .check svg { display: block; }
        .meal.done { opacity: .7; }
        .meal .meta { font-size: 12px; color: var(--muted); }
        .meal select {
            appearance: none; /* Hide default arrow */
            background: var(--soft) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236b7280"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 8px center; /* Custom SVG arrow */
            background-size: 16px; /* Size of custom arrow */
            border: 1px solid rgba(0,0,0,.15);
            color: var(--txt);
            border-radius: 8px;
            padding: 6px 30px 6px 8px; /* Adjust padding for custom arrow */
            width: 100%;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }
        .pill { display: inline-flex; align-items: center; gap: 8px; background: var(--soft); border: 1px solid rgba(0,0,0,.08); padding: 8px 10px; border-radius: 999px; }
        .pill.full-width { width: 100%; justify-content: space-between; }
        .pill input {
            appearance: none;
            background: #ffffff;
            border: 1px solid rgba(0,0,0,.15);
            color: var(--txt);
            border-radius: 8px;
            padding: 6px 8px;
            min-width: 84px;
            font-family: 'Inter', sans-serif;
            text-align: right;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .pill input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); /* iOS blue focus ring */
        }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .controls.col { flex-direction: column; align-items: stretch;}

        .btn { background: #ffffff; color: var(--blue); border: 1px solid var(--blue); padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn:hover { background: var(--blue); color: white; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4); transform: translateY(-1px); }
        .btn.brand { background: linear-gradient(180deg, #ffed77, #f6d20a); color: #161616; border: 0; box-shadow: 0 2px 8px rgba(244, 208, 12, 0.4); }
        .btn.brand:hover { background: linear-gradient(180deg, #f6d20a, #ffed77); box-shadow: 0 4px 12px rgba(244, 208, 12, 0.6); }

        .small { font-size: 12px; color: var(--muted); }
        .divider { height: 1px; background: rgba(0,0,0,.12); margin: 10px 0; }
        .hint { font-size: 12px; color: var(--muted); }
        .footer { margin-top: 10px; color: var(--muted); font-size: 12px; text-align: center;}
        a { color: var(--blue); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Custom Modal Styles (adapted for light theme) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--card);
            border: 1px solid rgba(0,0,0,.08);
            border-radius: var(--radius);
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0,0,0,.15);
            text-align: center;
            color: var(--txt);
        }
        .modal-content h4 {
            color: var(--txt);
            margin-bottom: 10px;
        }
        .modal-content p {
            color: var(--muted);
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modal-buttons .btn {
            min-width: 100px;
        }
        .modal-buttons .btn.brand {
            border: 0;
            background: var(--blue);
            color: white;
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
        }
        .modal-buttons .btn.brand:hover {
            background: #006ee6;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.5);
        }
        /* Styles for chart controls */
        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        .chart-controls label {
            font-size: 14px;
            color: var(--txt);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chart-controls select {
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 8px;
            padding: 6px 10px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            background-color: var(--soft);
            color: var(--txt);
            appearance: none; /* Hide default arrow */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236b7280"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px; /* Make space for the arrow */
            cursor: pointer;
        }
        .chart-controls input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid var(--muted);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .chart-controls input[type="checkbox"]:checked {
            background-color: var(--blue);
            border-color: var(--blue);
        }
        .chart-controls input[type="checkbox"]:checked::after {
            content: '‚úî'; /* Checkmark symbol */
            font-size: 12px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Specific mobile layout for controls to stack nicely */
        .controls.col {
            gap: 8px;
        }
        .controls .pill {
            margin: 0; /* Remove any default margin if present */
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div>
                <div class="badge" id="fecha"></div>
                <!-- Solo el nombre "Planity" en el encabezado para un dise√±o limpio -->
                <h1 class="title">Planity ¬∑ Tu d√≠a</h1>
            </div>
            <div class="topbar">
                <div class="seg" id="daySeg"></div>
            </div>
        </header>

        <div class="grid">
            <section class="card">
                <h3 style="margin:0 0 8px">Comidas + Entreno</h3>
                <div class="progress" title="Progreso del d√≠a"><span id="prog"></span></div>
                <div class="divider"></div>
                <div id="lista" class="grid" style="grid-template-columns:1fr"></div>
            </section>

            <section class="card">
                <h3 style="margin:0 0 8px">Registro F√≠sico</h3>
                <div class="controls col">
                    <label class="pill full-width">
                        Peso (kg) <input type="number" id="input-weight" placeholder="Ej: 75.5" step="0.1" aria-label="Peso en kilogramos">
                    </label>
                    <label class="pill full-width">
                        Grasa Corporal (%) <input type="number" id="input-bodyfat" placeholder="Ej: 20" step="0.1" min="1" max="50" aria-label="Grasa corporal en porcentaje">
                    </label>
                    <label class="pill full-width">
                        Agua (L) <input type="number" id="input-water" placeholder="Ej: 2.5" step="0.1" aria-label="Litros de agua consumidos">
                    </label>
                    <label class="pill full-width">
                        Pasos <input type="number" id="input-steps" placeholder="Ej: 8000" step="100" aria-label="N√∫mero de pasos">
                    </label>
                    <label class="pill full-width">
                        Sue√±o (h) <input type="number" id="input-sleep" placeholder="Ej: 7.5" step="0.1" aria-label="Horas de sue√±o">
                    </label>
                    <label class="pill full-width">
                        M√∫sculo (%) <input type="number" id="input-muscle" placeholder="Ej: 35.2" step="0.1" min="1" max="100" aria-label="Porcentaje de m√∫sculo">
                    </label>
                </div>
                <div style="height:10px"></div>
                <button class="btn brand" id="btnSavePhysicalRecord" style="width:100%;">Guardar Registro</button>
                <div class="divider"></div>
                <h4 style="margin:6px 0">Historial (√∫ltimos 7 d√≠as)</h4>
                <ul id="physicalRecordsList" class="small" style="list-style-type: none; padding: 0;">
                    <!-- Records will be injected here -->
                </ul>
            </section>

            <section class="card full-width-card"> <!-- New section for Goals -->
                <h3 style="margin:0 0 10px">Mis Metas Personalizadas üéØ</h3>
                <div class="controls col">
                    <label class="pill full-width">
                        Meta Peso (kg) <input type="number" id="goal-weight" placeholder="Ej: 70" step="0.1" aria-label="Meta de peso en kilogramos">
                    </label>
                    <label class="pill full-width">
                        Meta Grasa Corporal (%) <input type="number" id="goal-bodyfat" placeholder="Ej: 18" step="0.1" min="1" max="50" aria-label="Meta de grasa corporal en porcentaje">
                    </label>
                    <label class="pill full-width">
                        Meta Agua (L) <input type="number" id="goal-water" placeholder="Ej: 3" step="0.1" aria-label="Meta de litros de agua">
                    </label>
                    <label class="pill full-width">
                        Meta Pasos <input type="number" id="goal-steps" placeholder="Ej: 12000" step="100" aria-label="Meta de pasos">
                    </label>
                    <label class="pill full-width">
                        Meta Sue√±o (h) <input type="number" id="goal-sleep" placeholder="Ej: 8" step="0.1" aria-label="Meta de horas de sue√±o">
                    </label>
                    <label class="pill full-width">
                        Meta M√∫sculo (%) <input type="number" id="goal-muscle" placeholder="Ej: 40" step="0.1" min="1" max="100" aria-label="Meta de porcentaje de m√∫sculo">
                    </label>
                </div>
                <div style="height:10px"></div>
                <button class="btn brand" id="btnSaveGoals" style="width:100%;">Guardar Metas</button>
                <div class="divider"></div>
                <h4 style="margin:6px 0">Estado Actual de Metas:</h4>
                <ul id="goalsStatusList" class="small" style="list-style-type: none; padding: 0;">
                    <!-- Goal status will be injected here -->
                </ul>
            </section>

            <section class="card full-width-card"> <!-- Now a full-width card for chart -->
                <h3 style="margin:0 0 8px">Gr√°fica de Progreso</h3>
                <div class="chart-controls">
                    <label>
                        Rango:
                        <select id="chart-time-range">
                            <option value="7">√öltimos 7 d√≠as</option>
                            <option value="30">√öltimos 30 d√≠as</option>
                            <option value="all">Todo el historial</option>
                        </select>
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-weight" checked> Peso
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-bodyfat" checked> Grasa Corporal
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-water"> Agua
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-steps"> Pasos
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-sleep"> Sue√±o
                    </label>
                    <label>
                        <input type="checkbox" id="chart-show-muscle"> M√∫sculo
                    </label>
                </div>
                <div style="max-height: 300px;"><canvas id="progressChart"></canvas></div>
            </section>

            <aside class="card">
                <h3 style="margin:0 0 8px">Recordatorios</h3>
                <div class="controls">
                    <label class="pill">Desayuno <input type="time" id="t-des" aria-label="Hora de desayuno"></label>
                    <label class="pill">Almuerzo <input type="time" id="t-alm" aria-label="Hora de almuerzo"></label>
                    <label class="pill">Comida <input type="time" id="t-com" aria-label="Hora de comida"></label>
                    <label class="pill">Merienda <input type="time" id="t-mer" aria-label="Hora de merienda"></label>
                    <label class="pill">Cena <input type="time" id="t-cen" aria-label="Hora de cena"></label>
                    <label class="pill">Entreno <input type="time" id="t-ent" aria-label="Hora de entreno"></label>
                </div>
                <div style="height:8px"></div>
                <div class="row">
                    <button class="btn brand" id="btnNotif">Activar notificaciones</button>
                    <button class="btn" id="btnProgramar">Reprogramar hoy</button>
                </div>
                <p class="hint">Permite notificaciones del navegador para recibir avisos en los horarios elegidos. Funciona en Android y escritorio. En iOS, a√±ade a pantalla de inicio para mejor experiencia.</p>
                <div class="divider"></div>
                <h4 style="margin:6px 0">Consejos r√°pidos</h4>
                <ul class="small">
                    <li>Prote√≠na alta en cada comida (‚âà140 g/d√≠a).</li>
                    <li>Agua 2‚Äì2,5 L; caf√©/infusiones sin az√∫car.</li>
                    <li>30 min de fuerza/HIIT diarios + 8.000‚Äì10.000 pasos.</li>
                </ul>
            </aside>
        </div>

        <div class="footer">Hecho con ‚ù§Ô∏è para Rub√©n ¬∑ Estilo iOS ¬∑ <a href="javascript:void(0)" id="reset">reset</a></div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="customModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h4 id="modalTitle" style="margin-top:0;"></h4>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn brand" style="display:none;">Confirmar</button>
                <button id="modalCancelBtn" class="btn" style="display:none;">Cancelar</button>
                <button id="modalAlertBtn" class="btn brand">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('ServiceWorker registration failed: ', registrationError);
                    });
            });
        }

        // Default times for meals and workout
        const DEFAULT_TIMES = {
            des: "08:30", alm: "11:30", com: "14:00", mer: "17:30", cen: "21:00", ent: "19:00"
        };

        // Weekly plan data (meals and workouts) with alternatives
        const WEEK_PLAN = {
            "Lunes": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Tortilla 3 claras + 1 huevo + 40 g avena con manzana y canela", "Yogur griego 0% (150 g) + 30 g avena + 1 cdita ch√≠a", "Tostada integral (50 g) + 1/2 aguacate + at√∫n al natural"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Yogur griego 0% + 10 almendras", "Manzana + 2 lonchas jam√≥n serrano magro", "Mandarina + 10 nueces"] },
                    { k: "com", name: "Comida", options: ["150 g pollo plancha + 70 g arroz integral (crudo) + ensalada lechuga y zanahoria", "150 g ternera magra + 200 g patata asada + ensalada tomate y pepino", "150 g pavo al horno + 70 g quinoa (crudo) + ensalada lechuga y zanahoria"] },
                    { k: "mer", name: "Merienda", options: ["Pl√°tano + 1 loncha pavo", "Kiwi + 1 huevo duro", "Yogur griego 0% + 1 loncha de pavo"] },
                    { k: "cen", name: "Cena", options: ["150 g salm√≥n al horno + ensalada verde con 1/2 aguacate", "150 g at√∫n a la plancha + ensalada de espinacas + rodaja de mel√≥n", "Revuelto 3 claras + 1 huevo + champi√±ones + naranja"] }
                ],
                workout: "Empuje (press hombros, flexiones con goma, press suelo, fondos tr√≠ceps) ‚Äì 30 min"
            },
            "Martes": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Yogur griego 0% (150 g) + 20 g nueces + 80 g frutos rojos", "Tortilla 3 claras + 1 huevo + 40 g avena con manzana y canela", "Tostada integral (50 g) + 1/2 aguacate + at√∫n al natural"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Manzana + 2 lonchas jam√≥n serrano magro", "Yogur griego 0% + 10 almendras", "Kiwi + 1 huevo duro"] },
                    { k: "com", name: "Comida", options: ["150 g ternera magra + 200 g patata asada + ensalada tomate y pepino", "150 g pollo plancha + 70 g arroz integral (crudo) + ensalada lechuga y zanahoria", "150 g lomo de cerdo magro + 200 g boniato asado + ensalada tomate"] },
                    { k: "mer", name: "Merienda", options: ["Kiwi + 1 huevo duro", "Pl√°tano + 1 loncha pavo", "Mandarina + 10 nueces"] },
                    { k: "cen", name: "Cena", options: ["150 g at√∫n a la plancha + ensalada de espinacas + rodaja de mel√≥n", "150 g salm√≥n al horno + ensalada verde con 1/2 aguacate", "Tortilla 2 huevos + 2 claras + calabac√≠n + rodaja de mel√≥n"] }
                ],
                workout: "Pierna (sentadillas, peso muerto rumano, zancadas, gemelos) ‚Äì 30 min"
            },
            "Mi√©rcoles": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Batido: 250 ml leche semidesnadada + 1 pl√°tano + 30 g prote√≠na", "Yogur griego 0% (150 g) + 30 g avena + 1 cdita ch√≠a", "Revuelto 2 claras + 1 huevo + 40 g jam√≥n serrano magro + pan integral (40 g) + pl√°tano"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Mandarina + 10 nueces", "Manzana + 10 almendras", "Pl√°tano + 2 lonchas de pavo"] },
                    { k: "com", name: "Comida", options: ["150 g pavo al horno + 70 g quinoa (crudo) + ensalada lechuga y zanahoria", "150 g pollo al curry ligero + 70 g arroz basmati (crudo) + ensalada", "Ensalada de garbanzos (100 g cocidos) + at√∫n + huevo duro + mandarina"] },
                    { k: "mer", name: "Merienda", options: ["Yogur griego 0% + 1 loncha de pavo", "Kiwi + 2 lonchas jam√≥n cocido", "Manzana + 1 loncha jam√≥n serrano"] },
                    { k: "cen", name: "Cena", options: ["Revuelto 3 claras + 1 huevo + champi√±ones + naranja", "150 g salm√≥n plancha + ensalada de r√∫cula + rodaja de pi√±a", "Ensalada de garbanzos (100 g cocidos) + at√∫n + huevo duro + mandarina"] }
                ],
                workout: "Core + HIIT (plancha, russian twist, bici abdominal, burpees) ‚Äì 30 min"
            },
            "Jueves": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Tostada integral (50 g) + 1/2 aguacate + at√∫n al natural", "Tortilla 3 claras + 1 huevo + 40 g avena con manzana y canela", "Yogur griego 0% (150 g) + 20 g nueces + 80 g frutos rojos"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Manzana + 10 almendras", "Mandarina + 10 nueces", "Kiwi + 10 almendras"] },
                    { k: "com", name: "Comida", options: ["150 g pollo al curry ligero + 70 g arroz basmati (crudo) + ensalada", "150 g ternera magra + 200 g patata asada + ensalada tomate y pepino", "Paella ligera de marisco (‚âà70 g arroz crudo) + ensalada de tomate"] },
                    { k: "mer", name: "Merienda", options: ["Kiwi + 2 lonchas jam√≥n cocido", "Pl√°tano + 1 loncha pavo", "Yogur griego 0% + 1 loncha de pavo"] },
                    { k: "cen", name: "Cena", options: ["150 g salm√≥n plancha + ensalada de r√∫cula + rodaja de pi√±a", "Revuelto 3 claras + 1 huevo + champi√±ones + naranja", "150 g pescado (salm√≥n o at√∫n) + ensalada verde con aguacate"] }
                ],
                workout: "Tir√≥n (remo mancuernas, curl b√≠ceps, face pull con goma) ‚Äì 30 min"
            },
            "Viernes": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Yogur griego 0% (150 g) + 30 g avena + 1 cdita ch√≠a", "Batido: 250 ml leche semidesnatada + 1 pl√°tano + 30 g prote√≠na", "Tortitas fit (50 g avena + 2 claras + 1 huevo) + kiwi"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Pl√°tano + 2 lonchas de pavo", "Manzana + 10 almendras", "Kiwi + 2 lonchas jam√≥n cocido"] },
                    { k: "com", name: "Comida", options: ["150 g lomo de cerdo magro + 200 g boniato asado + ensalada tomate", "150 g pollo al curry ligero + 70 g arroz basmati (crudo) + ensalada", "150 g pavo al horno + 70 g quinoa (crudo) + ensalada lechuga y zanahoria"] },
                    { k: "mer", name: "Merienda", options: ["Mandarina + 10 nueces", "Kiwi + 2 lonchas jam√≥n cocido", "Yogur griego 0% + 1 loncha de pavo"] },
                    { k: "cen", name: "Cena", options: ["Tortilla 2 huevos + 2 claras + calabac√≠n + rodaja de mel√≥n", "150 g salm√≥n plancha + ensalada de r√∫cula + rodaja de pi√±a", "Revuelto 3 claras + 1 huevo + champi√±ones + naranja"] }
                ],
                workout: "Full Body (sentadilla+press, peso muerto+remo, flexiones, plancha) ‚Äì 30 min"
            },
            "S√°bado": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Tortitas fit (50 g avena + 2 claras + 1 huevo) + kiwi", "Yogur griego 0% (150 g) + 20 g nueces + 80 g frutos rojos", "Tostada integral (50 g) + 1/2 aguacate + at√∫n al natural"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Yogur griego 0% + 10 almendras", "Manzana + 2 lonchas jam√≥n serrano magro", "Pl√°tano + 2 lonchas de pavo"] },
                    { k: "com", name: "Comida", options: ["150 g pollo plancha + 200 g patata cocida + ensalada (sin br√≥coli)", "150 g lomo de cerdo magro + 200 g boniato asado + ensalada tomate", "Paella ligera de marisco (‚âà70 g arroz crudo) + ensalada de tomate"] },
                    { k: "mer", name: "Merienda", options: ["Manzana + 1 loncha jam√≥n serrano", "Kiwi + 1 huevo duro", "Mandarina + 10 nueces"] },
                    { k: "cen", name: "Cena", options: ["Ensalada de garbanzos (100 g cocidos) + at√∫n + huevo duro + mandarina", "150 g at√∫n a la plancha + ensalada de espinacas + rodaja de mel√≥n", "Tortilla 2 huevos + 2 claras + calabac√≠n + rodaja de mel√≥n"] }
                ],
                workout: "Cardio libre (andar r√°pido / bici) ‚Äì 30‚Äì40 min"
            },
            "Domingo": {
                meals: [
                    { k: "des", name: "Desayuno", options: ["Revuelto 2 claras + 1 huevo + 40 g jam√≥n serrano magro + pan integral (40 g) + pl√°tano", "Batido: 250 ml leche semidesnatada + 1 pl√°tano + 30 g prote√≠na", "Tortitas fit (50 g avena + 2 claras + 1 huevo) + kiwi"] },
                    { k: "alm", name: "Almuerzo (media ma√±ana)", options: ["Kiwi + 10 almendras", "Yogur griego 0% + 10 almendras", "Mandarina + 10 nueces"] },
                    { k: "com", name: "Comida", options: ["Paella ligera de marisco (‚âà70 g arroz crudo) + ensalada de tomate", "150 g pollo plancha + 200 g patata cocida + ensalada (sin br√≥coli)", "150 g ternera magra + 200 g patata asada + ensalada tomate y pepino"] },
                    { k: "mer", name: "Merienda", options: ["Yogur griego 0% + 1 loncha de pavo", "Manzana + 1 loncha jam√≥n serrano", "Kiwi + 2 lonchas jam√≥n cocido"] },
                    { k: "cen", name: "Cena", options: ["150 g pescado (salm√≥n o at√∫n) + ensalada verde con aguacate", "Ensalada de garbanzos (100 g cocidos) + at√∫n + huevo duro + mandarina", "150 g salm√≥n al horno + ensalada verde con 1/2 aguacate"] }
                ],
                workout: "Descanso activo (paseo + estiramientos) ‚Äì 20‚Äì30 min"
            }
        };

        // Reordered DAY_NAMES to start on Lunes (Monday is 0, Sunday is 6 in this array)
        const DAY_NAMES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];

        // Local Storage Keys
        const LS_KEY_DAY = 'lf-day';
        const LS_KEY_DONE = 'lf-done';
        const LS_KEY_TIMES = 'lf-times';
        const LS_KEY_ALTERNATIVES = 'lf-alternatives'; // New key for selected alternatives
        const LS_KEY_PHYSICAL_RECORDS = 'lf-physical-records'; // New key for physical records
        const LS_KEY_GOALS = 'lf-goals'; // New key for goals

        // DOM Element references
        const DOMElements = {
            fecha: document.getElementById('fecha'),
            daySeg: document.getElementById('daySeg'),
            lista: document.getElementById('lista'),
            prog: document.getElementById('prog'),
            btnNotif: document.getElementById('btnNotif'),
            btnProgramar: document.getElementById('btnProgramar'),
            resetBtn: document.getElementById('reset'),
            timeInputs: {
                des: document.getElementById('t-des'),
                alm: document.getElementById('t-alm'),
                com: document.getElementById('t-com'),
                mer: document.getElementById('t-mer'),
                cen: document.getElementById('t-cen'),
                ent: document.getElementById('t-ent')
            },
            // Physical record elements
            inputWeight: document.getElementById('input-weight'),
            inputBodyfat: document.getElementById('input-bodyfat'),
            inputWater: document.getElementById('input-water'),
            inputSteps: document.getElementById('input-steps'),
            inputSleep: document.getElementById('input-sleep'),
            inputMuscle: document.getElementById('input-muscle'),
            btnSavePhysicalRecord: document.getElementById('btnSavePhysicalRecord'),
            physicalRecordsList: document.getElementById('physicalRecordsList'),

            // Goal elements
            inputGoalWeight: document.getElementById('goal-weight'),
            inputGoalBodyfat: document.getElementById('goal-bodyfat'),
            inputGoalWater: document.getElementById('goal-water'),
            inputGoalSteps: document.getElementById('goal-steps'),
            inputGoalSleep: document.getElementById('goal-sleep'),
            inputGoalMuscle: document.getElementById('goal-muscle'),
            btnSaveGoals: document.getElementById('btnSaveGoals'),
            goalsStatusList: document.getElementById('goalsStatusList'),

            // Chart elements
            progressChart: document.getElementById('progressChart'),
            chartTimeRange: document.getElementById('chart-time-range'),
            chartShowWeight: document.getElementById('chart-show-weight'),
            chartShowBodyfat: document.getElementById('chart-show-bodyfat'),
            chartShowWater: document.getElementById('chart-show-water'),
            chartShowSteps: document.getElementById('chart-show-steps'),
            chartShowSleep: document.getElementById('chart-show-sleep'),
            chartShowMuscle: document.getElementById('chart-show-muscle'),

            customModal: document.getElementById('customModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalMessage: document.getElementById('modalMessage'),
            modalConfirmBtn: document.getElementById('modalConfirmBtn'),
            modalCancelBtn: document.getElementById('modalCancelBtn'),
            modalAlertBtn: document.getElementById('modalAlertBtn')
        };

        // Helper to get the current day of the week, starting with Monday as 0
        function getDayOfWeekAdjusted() {
            const day = new Date().getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
            return (day === 0) ? 6 : day - 1; // Map Sunday (0) to 6 (Domingo), and adjust others
        }

        // Global state
        let appState = {
            day: localStorage.getItem(LS_KEY_DAY) || DAY_NAMES[getDayOfWeekAdjusted()], // Adjusted for Monday start
            done: JSON.parse(localStorage.getItem(LS_KEY_DONE) || '{}'),
            times: JSON.parse(localStorage.getItem(LS_KEY_TIMES) || JSON.stringify(DEFAULT_TIMES)),
            selectedAlternatives: JSON.parse(localStorage.getItem(LS_KEY_ALTERNATIVES) || '{}'),
            physicalRecords: JSON.parse(localStorage.getItem(LS_KEY_PHYSICAL_RECORDS) || '{}'),
            goals: JSON.parse(localStorage.getItem(LS_KEY_GOALS) || '{}'), // New state for goals
            chartSettings: {
                timeRange: localStorage.getItem('chart-time-range') || '7',
                showWeight: JSON.parse(localStorage.getItem('chart-show-weight') || 'true'),
                showBodyfat: JSON.parse(localStorage.getItem('chart-show-bodyfat') || 'true'),
                showWater: JSON.parse(localStorage.getItem('chart-show-water') || 'false'),
                showSteps: JSON.parse(localStorage.getItem('chart-show-steps') || 'false'),
                showSleep: JSON.parse(localStorage.getItem('chart-show-sleep') || 'false'),
                showMuscle: JSON.parse(localStorage.getItem('chart-show-muscle') || 'false')
            }
        };

        let notificationTimeouts = [];
        let progressChartInstance;

        /**
         * Saves the current application state to local storage.
         */
        function saveState() {
            localStorage.setItem(LS_KEY_DAY, appState.day);
            localStorage.setItem(LS_KEY_DONE, JSON.stringify(appState.done));
            localStorage.setItem(LS_KEY_TIMES, JSON.stringify(appState.times));
            localStorage.setItem(LS_KEY_ALTERNATIVES, JSON.stringify(appState.selectedAlternatives));
            localStorage.setItem(LS_KEY_PHYSICAL_RECORDS, JSON.stringify(appState.physicalRecords));
            localStorage.setItem(LS_KEY_GOALS, JSON.stringify(appState.goals)); // Save goals
            localStorage.setItem('chart-time-range', appState.chartSettings.timeRange);
            localStorage.setItem('chart-show-weight', JSON.stringify(appState.chartSettings.showWeight));
            localStorage.setItem('chart-show-bodyfat', JSON.stringify(appState.chartSettings.showBodyfat));
            localStorage.setItem('chart-show-water', JSON.stringify(appState.chartSettings.showWater));
            localStorage.setItem('chart-show-steps', JSON.stringify(appState.chartSettings.showSteps));
            localStorage.setItem('chart-show-sleep', JSON.stringify(appState.chartSettings.showSleep));
            localStorage.setItem('chart-show-muscle', JSON.stringify(appState.chartSettings.showMuscle));
        }

        /**
         * Formats a Date object into a readable Spanish string.
         * @param {Date} d - The date to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(d, includeYear = true) {
            const opts = { weekday: 'long', month: 'long', day: 'numeric' };
            if (includeYear) opts.year = 'numeric';
            return new Intl.DateTimeFormat('es-ES', opts).format(d).replace(/^./, c => c.toUpperCase());
        }

        /**
         * Formats a Date object into a YYYY-MM-DD string for keys.
         * @param {Date} date - The date object.
         * @returns {string} Date in YYYY-MM-DD format.
         */
        function formatKeyDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Displays a custom alert modal.
         * @param {string} title - The title of the alert.
         * @param {string} message - The message content.
         */
        function showCustomAlert(title, message) {
            DOMElements.modalTitle.textContent = title;
            DOMElements.modalMessage.textContent = message;
            DOMElements.modalConfirmBtn.style.display = 'none';
            DOMElements.modalCancelBtn.style.display = 'none';
            DOMElements.modalAlertBtn.style.display = 'inline-block';
            DOMElements.customModal.style.display = 'flex';

            DOMElements.modalAlertBtn.onclick = () => {
                DOMElements.customModal.style.display = 'none';
            };
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} title - The title of the confirmation.
         * @param {string} message - The message content.
         * @param {function} onConfirm - Callback function to execute if confirmed.
         */
        function showCustomConfirm(title, message, onConfirm) {
            DOMElements.modalTitle.textContent = title;
            DOMElements.modalMessage.textContent = message;
            DOMElements.modalConfirmBtn.style.display = 'inline-block';
            DOMElements.modalCancelBtn.style.display = 'inline-block';
            DOMElements.modalAlertBtn.style.display = 'none';
            DOMElements.customModal.style.display = 'flex';

            DOMElements.modalConfirmBtn.onclick = () => {
                DOMElements.customModal.style.display = 'none';
                onConfirm();
            };
            DOMElements.modalCancelBtn.onclick = () => {
                DOMElements.customModal.style.display = 'none';
            };
        }

        /**
         * Renders the current date and day selection buttons.
         */
        function renderTopBar() {
            DOMElements.fecha.textContent = formatDate(new Date());
            DOMElements.daySeg.innerHTML = '';
            DAY_NAMES.forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = name === appState.day ? 'active' : '';
                button.addEventListener('click', () => {
                    appState.day = name;
                    saveState();
                    renderAll();
                });
                DOMElements.daySeg.appendChild(button);
            });
        }

        /**
         * Renders the list of meals and workout for the selected day.
         * Updates the progress bar. Includes meal alternatives.
         */
        function renderPlanList() {
            DOMElements.lista.innerHTML = '';
            const data = WEEK_PLAN[appState.day];
            let countDone = 0;
            const totalItems = data.meals.length + 1; // +1 for the workout

            const itemsToRender = data.meals.map(m => ({
                k: m.k,
                name: m.name,
                options: m.options
            })).concat([{ k: 'ent', name: 'Entreno', options: [data.workout] }]);

            itemsToRender.forEach(item => {
                const id = `${appState.day}-${item.k}`;
                appState.done[appState.day] = appState.done[appState.day] || {};
                const done = !!appState.done[appState.day][id];

                if (done) countDone++;

                const mealElement = document.createElement('div');
                mealElement.className = 'meal' + (done ? ' done' : '');

                let optionsHtml = '';
                if (item.options && item.options.length > 0) {
                    const selectedIndex = appState.selectedAlternatives[id] !== undefined ? appState.selectedAlternatives[id] : 0;
                    optionsHtml = `<select data-item-id="${id}" class="meal-select">`;
                    item.options.forEach((option, index) => {
                        optionsHtml += `<option value="${index}" ${index === selectedIndex ? 'selected' : ''}>${option}</option>`;
                    });
                    optionsHtml += `</select>`;
                } else {
                    optionsHtml = `<div class="meta">${item.options[0] || ''}</div>`;
                }

                mealElement.innerHTML = `
                    <div class="meal-header">
                        <div class="check" role="checkbox" aria-checked="${done}" data-id="${id}">
                            <svg viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                            </svg>
                        </div>
                        <div style="font-weight:700; color: var(--txt);">${item.name}</div>
                    </div>
                    ${optionsHtml}
                `;

                mealElement.querySelector('.check').addEventListener('click', () => {
                    toggleCompletion(id);
                });

                const selectElement = mealElement.querySelector('.meal-select');
                if (selectElement) {
                    selectElement.addEventListener('change', (e) => {
                        appState.selectedAlternatives[id] = parseInt(e.target.value, 10);
                        saveState();
                    });
                }

                DOMElements.lista.appendChild(mealElement);
            });

            const percentage = Math.round((countDone / totalItems) * 100);
            DOMElements.prog.style.width = percentage + '%';
        }

        /**
         * Toggles the completion status of an item and re-renders the list.
         * @param {string} id - The unique ID of the item (e.g., "Lunes-des").
         */
        function toggleCompletion(id) {
            appState.done[appState.day] = appState.done[appState.day] || {};
            appState.done[appState.day][id] = !appState.done[appState.day][id];
            saveState();
            renderPlanList();
        }

        /**
         * Renders the time input values and attaches change listeners.
         */
        function renderTimes() {
            for (const key in DOMElements.timeInputs) {
                const inputElement = DOMElements.timeInputs[key];
                inputElement.value = appState.times[key] || DEFAULT_TIMES[key];
                inputElement.addEventListener('change', (e) => {
                    appState.times[key] = e.target.value;
                    saveState();
                });
            }
        }

        /**
         * Renders the physical records list and populates current day's inputs.
         */
        function renderPhysicalRecords() {
            const todayKey = formatKeyDate(new Date());
            const todayRecord = appState.physicalRecords[todayKey];

            // Populate inputs for today
            DOMElements.inputWeight.value = todayRecord ? todayRecord.weight : '';
            DOMElements.inputBodyfat.value = todayRecord ? todayRecord.bodyfat : '';
            DOMElements.inputWater.value = todayRecord ? todayRecord.water : '';
            DOMElements.inputSteps.value = todayRecord ? todayRecord.steps : '';
            DOMElements.inputSleep.value = todayRecord ? todayRecord.sleep : '';
            DOMElements.inputMuscle.value = todayRecord ? todayRecord.muscle : '';

            // Render history (last 7 days)
            DOMElements.physicalRecordsList.innerHTML = '';
            const sortedDates = Object.keys(appState.physicalRecords)
                                    .sort((a, b) => new Date(b) - new Date(a))
                                    .slice(0, 7); // Show last 7 days

            if (sortedDates.length === 0) {
                DOMElements.physicalRecordsList.innerHTML = `<li>No hay registros a√∫n.</li>`;
                return;
            }

            sortedDates.forEach(dateKey => {
                const record = appState.physicalRecords[dateKey];
                if (record) {
                    const listItem = document.createElement('li');
                    let recordText = `${formatDate(new Date(dateKey), false)}: ${record.weight} kg, ${record.bodyfat}% grasa`;
                    if (record.water !== null) recordText += `, ${record.water}L agua`;
                    if (record.steps !== null) recordText += `, ${record.steps} pasos`;
                    if (record.sleep !== null) recordText += `, ${record.sleep}h sue√±o`;
                    if (record.muscle !== null) recordText += `, ${record.muscle}% m√∫sculo`;
                    listItem.textContent = recordText;
                    DOMElements.physicalRecordsList.appendChild(listItem);
                }
            });
        }

        /**
         * Saves a new physical record (weight and bodyfat).
         */
        function savePhysicalRecord() {
            const weight = parseFloat(DOMElements.inputWeight.value);
            const bodyfat = parseFloat(DOMElements.inputBodyfat.value);
            const water = parseFloat(DOMElements.inputWater.value);
            const steps = parseInt(DOMElements.inputSteps.value, 10);
            const sleep = parseFloat(DOMElements.inputSleep.value);
            const muscle = parseFloat(DOMElements.inputMuscle.value);
            const todayKey = formatKeyDate(new Date());

            if (isNaN(weight) || isNaN(bodyfat) || weight <= 0 || bodyfat <= 0 || bodyfat > 100) {
                showCustomAlert('Error de Registro', 'Por favor, introduce valores v√°lidos para peso (kg) y grasa corporal (%).');
                return;
            }
            if (!isNaN(water) && (water < 0 || water > 10)) {
                showCustomAlert('Error de Registro', 'El valor de agua (L) debe ser entre 0 y 10.');
                return;
            }
            if (!isNaN(steps) && steps < 0) {
                showCustomAlert('Error de Registro', 'Los pasos no pueden ser un valor negativo.');
                return;
            }
            if (!isNaN(sleep) && (sleep < 0 || sleep > 24)) {
                showCustomAlert('Error de Registro', 'Las horas de sue√±o deben ser entre 0 y 24.');
                return;
            }
            if (!isNaN(muscle) && (muscle < 1 || muscle > 100)) {
                showCustomAlert('Error de Registro', 'El porcentaje de m√∫sculo debe ser entre 1 y 100.');
                return;
            }

            appState.physicalRecords[todayKey] = {
                weight,
                bodyfat,
                water: isNaN(water) ? null : water,
                steps: isNaN(steps) ? null : steps,
                sleep: isNaN(sleep) ? null : sleep,
                muscle: isNaN(muscle) ? null : muscle
            };
            saveState();
            renderPhysicalRecords();
            renderGoalsStatus(); // Update goals status after saving new record
            renderProgressChart();
            showCustomAlert('Registro Guardado', 'Tu registro f√≠sico ha sido guardado con √©xito. Nuevas m√©tricas a√±adidas.');
        }

        /**
         * Renders the goal input values and attaches change listeners.
         */
        function renderGoalsInputs() {
            DOMElements.inputGoalWeight.value = appState.goals.weight || '';
            DOMElements.inputGoalBodyfat.value = appState.goals.bodyfat || '';
            DOMElements.inputGoalWater.value = appState.goals.water || '';
            DOMElements.inputGoalSteps.value = appState.goals.steps || '';
            DOMElements.inputGoalSleep.value = appState.goals.sleep || '';
            DOMElements.inputGoalMuscle.value = appState.goals.muscle || '';
        }

        /**
         * Saves the user-defined goals.
         */
        function saveGoals() {
            const weight = parseFloat(DOMElements.inputGoalWeight.value);
            const bodyfat = parseFloat(DOMElements.inputGoalBodyfat.value);
            const water = parseFloat(DOMElements.inputGoalWater.value);
            const steps = parseInt(DOMElements.inputGoalSteps.value, 10);
            const sleep = parseFloat(DOMElements.inputGoalSleep.value);
            const muscle = parseFloat(DOMElements.inputGoalMuscle.value);

            // Basic validation for goals (allow empty, but validate if entered)
            if (!isNaN(weight) && weight <= 0) {
                showCustomAlert('Error de Meta', 'La meta de peso debe ser un valor positivo.');
                return;
            }
            if (!isNaN(bodyfat) && (bodyfat <= 0 || bodyfat > 100)) {
                showCustomAlert('Error de Meta', 'La meta de grasa corporal debe ser entre 1 y 100%.');
                return;
            }
            if (!isNaN(water) && (water < 0 || water > 10)) {
                showCustomAlert('Error de Meta', 'La meta de agua (L) debe ser entre 0 y 10.');
                return;
            }
            if (!isNaN(steps) && steps < 0) {
                showCustomAlert('Error de Meta', 'La meta de pasos no puede ser negativa.');
                return;
            }
            if (!isNaN(sleep) && (sleep < 0 || sleep > 24)) {
                showCustomAlert('Error de Meta', 'La meta de sue√±o (h) debe ser entre 0 y 24.');
                return;
            }
            if (!isNaN(muscle) && (muscle < 1 || muscle > 100)) {
                showCustomAlert('Error de Meta', 'La meta de m√∫sculo (%) debe ser entre 1 y 100.');
                return;
            }

            appState.goals = {
                weight: isNaN(weight) ? null : weight,
                bodyfat: isNaN(bodyfat) ? null : bodyfat,
                water: isNaN(water) ? null : water,
                steps: isNaN(steps) ? null : steps,
                sleep: isNaN(sleep) ? null : sleep,
                muscle: isNaN(muscle) ? null : muscle
            };
            saveState();
            renderGoalsStatus();
            renderProgressChart(); // Update chart with goal lines
            showCustomAlert('Metas Guardadas', 'Tus metas personalizadas han sido guardadas con √©xito.');
        }

        /**
         * Renders the current status against the defined goals.
         */
        function renderGoalsStatus() {
            DOMElements.goalsStatusList.innerHTML = '';
            const goals = appState.goals;
            const todayKey = formatKeyDate(new Date());
            const lastRecord = appState.physicalRecords[todayKey] || getLastValidRecord();

            if (!goals.weight && !goals.bodyfat && !goals.water && !goals.steps && !goals.sleep && !goals.muscle) {
                DOMElements.goalsStatusList.innerHTML = `<li>No has establecido ninguna meta a√∫n.</li>`;
                return;
            }

            const appendGoalStatus = (metricName, currentVal, goalVal, unit, isLowerBetter = false) => {
                if (goalVal !== null) {
                    let statusText = `Meta ${metricName}: ${goalVal}${unit}`;
                    if (lastRecord && currentVal !== null) {
                        let difference = currentVal - goalVal;
                        let icon = '';
                        if (isLowerBetter) { // For metrics where lower is better (e.g., bodyfat)
                            if (currentVal <= goalVal) {
                                icon = '‚úÖ'; // Achieved or surpassed
                                statusText += ` (¬°Lograda! ${currentVal}${unit})`;
                            } else {
                                icon = '‚¨ÜÔ∏è'; // Still above goal
                                statusText += ` (Actual: ${currentVal}${unit})`;
                            }
                        } else { // For metrics where higher is better (e.g., weight, muscle, steps, water, sleep)
                            if (currentVal >= goalVal) {
                                icon = '‚úÖ'; // Achieved or surpassed
                                statusText += ` (¬°Lograda! ${currentVal}${unit})`;
                            } else {
                                icon = '‚¨áÔ∏è'; // Still below goal
                                statusText += ` (Actual: ${currentVal}${unit})`;
                            }
                        }
                    } else {
                        statusText += ` (Sin datos actuales)`;
                    }
                    const listItem = document.createElement('li');
                    listItem.textContent = statusText;
                    DOMElements.goalsStatusList.appendChild(listItem);
                }
            };

            // Get the last recorded values for comparison
            const currentWeight = lastRecord?.weight ?? null;
            const currentBodyfat = lastRecord?.bodyfat ?? null;
            const currentWater = lastRecord?.water ?? null;
            const currentSteps = lastRecord?.steps ?? null;
            const currentSleep = lastRecord?.sleep ?? null;
            const currentMuscle = lastRecord?.muscle ?? null;

            appendGoalStatus('Peso', currentWeight, goals.weight, ' kg');
            appendGoalStatus('Grasa Corporal', currentBodyfat, goals.bodyfat, '%', true); // Lower is better for bodyfat
            appendGoalStatus('Agua', currentWater, goals.water, ' L');
            appendGoalStatus('Pasos', currentSteps, goals.steps, '');
            appendGoalStatus('Sue√±o', currentSleep, goals.sleep, ' h');
            appendGoalStatus('M√∫sculo', currentMuscle, goals.muscle, '%');
        }

        /**
         * Helper to get the last valid physical record if today's is not available.
         */
        function getLastValidRecord() {
            const sortedRecordsKeys = Object.keys(appState.physicalRecords)
                .sort((a, b) => new Date(b) - new Date(a)); // Sort newest to oldest
            for (const dateKey of sortedRecordsKeys) {
                if (appState.physicalRecords[dateKey]) {
                    return appState.physicalRecords[dateKey];
                }
            }
            return null;
        }

        /**
         * Renders the progress chart using Chart.js with dynamic datasets and time range.
         */
        function renderProgressChart() {
            if (!DOMElements.progressChart) return;

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }

            // Filter records based on time range setting
            const allRecordsKeys = Object.keys(appState.physicalRecords)
                .sort((a, b) => new Date(a) - new Date(b)); // Always sort oldest to newest for chart

            let filteredRecordsKeys = [];
            const timeRange = appState.chartSettings.timeRange;
            if (timeRange === 'all') {
                filteredRecordsKeys = allRecordsKeys;
            } else {
                const days = parseInt(timeRange, 10);
                const cutOffDate = new Date();
                cutOffDate.setDate(cutOffDate.getDate() - days);
                filteredRecordsKeys = allRecordsKeys.filter(dateKey => new Date(dateKey) >= cutOffDate);
            }


            const labels = filteredRecordsKeys.map(dateKey => formatDate(new Date(dateKey), false));
            const datasets = [];
            const scales = {
                x: {
                    ticks: { color: 'var(--muted)' },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                yWeight: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Peso (kg)', color: 'var(--txt)' },
                    ticks: { color: 'var(--muted)' },
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    display: false // Hidden by default, only show if weight or bodyfat is active
                },
                yOther: { // Generic right axis for other metrics
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Valores', color: 'var(--txt)' },
                    ticks: { color: 'var(--muted)' },
                    grid: { drawOnChartArea: false, color: 'rgba(0,0,0,0.05)' },
                    display: false // Hidden by default
                }
            };

            const dataMap = {
                weight: { label: 'Peso (kg)', data: [], borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', yAxisID: 'yWeight', goal: appState.goals.weight },
                bodyfat: { label: 'Grasa Corporal (%)', data: [], borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.2)', yAxisID: 'yWeight', goal: appState.goals.bodyfat },
                water: { label: 'Agua (L)', data: [], borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.2)', yAxisID: 'yOther', goal: appState.goals.water },
                steps: { label: 'Pasos', data: [], borderColor: 'rgb(255, 205, 86)', backgroundColor: 'rgba(255, 205, 86, 0.2)', yAxisID: 'yOther', goal: appState.goals.steps },
                sleep: { label: 'Sue√±o (h)', data: [], borderColor: 'rgb(153, 102, 255)', backgroundColor: 'rgba(153, 102, 255, 0.2)', yAxisID: 'yOther', goal: appState.goals.sleep },
                muscle: { label: 'M√∫sculo (%)', data: [], borderColor: 'rgb(201, 203, 207)', backgroundColor: 'rgba(201, 203, 207, 0.2)', yAxisID: 'yOther', goal: appState.goals.muscle }
            };

            let showYWeight = false;
            let showYOther = false;

            filteredRecordsKeys.forEach(dateKey => {
                const record = appState.physicalRecords[dateKey];
                if (record) {
                    if (appState.chartSettings.showWeight) dataMap.weight.data.push(record.weight); else dataMap.weight.data.push(null);
                    if (appState.chartSettings.showBodyfat) dataMap.bodyfat.data.push(record.bodyfat); else dataMap.bodyfat.data.push(null);
                    if (appState.chartSettings.showWater) dataMap.water.data.push(record.water); else dataMap.water.data.push(null);
                    if (appState.chartSettings.showSteps) dataMap.steps.data.push(record.steps); else dataMap.steps.data.push(null);
                    if (appState.chartSettings.showSleep) dataMap.sleep.data.push(record.sleep); else dataMap.sleep.data.push(null);
                    if (appState.chartSettings.showMuscle) dataMap.muscle.data.push(record.muscle); else dataMap.muscle.data.push(null);
                } else {
                    Object.values(dataMap).forEach(m => m.data.push(null));
                }
            });

            // Add datasets if selected and have data
            if (appState.chartSettings.showWeight && dataMap.weight.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.weight, fill: false, spanGaps: true });
                showYWeight = true;
                if (dataMap.weight.goal !== null) {
                    datasets.push({
                        label: 'Meta Peso',
                        data: Array(labels.length).fill(dataMap.weight.goal),
                        borderColor: 'rgb(75, 192, 192, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yWeight'
                    });
                }
            }
            if (appState.chartSettings.showBodyfat && dataMap.bodyfat.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.bodyfat, fill: false, spanGaps: true });
                showYWeight = true; // Bodyfat uses same Y axis as weight
                if (dataMap.bodyfat.goal !== null) {
                    datasets.push({
                        label: 'Meta Grasa Corporal',
                        data: Array(labels.length).fill(dataMap.bodyfat.goal),
                        borderColor: 'rgb(255, 99, 132, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yWeight'
                    });
                }
            }
            if (appState.chartSettings.showWater && dataMap.water.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.water, fill: false, spanGaps: true });
                showYOther = true;
                if (dataMap.water.goal !== null) {
                    datasets.push({
                        label: 'Meta Agua',
                        data: Array(labels.length).fill(dataMap.water.goal),
                        borderColor: 'rgb(54, 162, 235, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yOther'
                    });
                }
            }
            if (appState.chartSettings.showSteps && dataMap.steps.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.steps, fill: false, spanGaps: true });
                showYOther = true;
                if (dataMap.steps.goal !== null) {
                    datasets.push({
                        label: 'Meta Pasos',
                        data: Array(labels.length).fill(dataMap.steps.goal),
                        borderColor: 'rgb(255, 205, 86, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yOther'
                    });
                }
            }
            if (appState.chartSettings.showSleep && dataMap.sleep.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.sleep, fill: false, spanGaps: true });
                showYOther = true;
                if (dataMap.sleep.goal !== null) {
                    datasets.push({
                        label: 'Meta Sue√±o',
                        data: Array(labels.length).fill(dataMap.sleep.goal),
                        borderColor: 'rgb(153, 102, 255, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yOther'
                    });
                }
            }
            if (appState.chartSettings.showMuscle && dataMap.muscle.data.some(v => v !== null)) {
                datasets.push({ ...dataMap.muscle, fill: false, spanGaps: true });
                showYOther = true;
                if (dataMap.muscle.goal !== null) {
                    datasets.push({
                        label: 'Meta M√∫sculo',
                        data: Array(labels.length).fill(dataMap.muscle.goal),
                        borderColor: 'rgb(201, 203, 207, 0.7)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        tension: 0,
                        fill: false,
                        yAxisID: 'yOther'
                    });
                }
            }

            scales.yWeight.display = showYWeight;
            scales.yOther.display = showYOther;

            const ctx = DOMElements.progressChart.getContext('2d');
            progressChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--txt)'
                            }
                        }
                    },
                    scales: scales
                }
            });
        }


        /**
         * Requests notification permission from the user.
         */
        function requestNotifications() {
            if (!('Notification' in window)) {
                showCustomAlert('Error', 'Tu navegador no soporta notificaciones.');
                return;
            }
            if (Notification.permission === 'granted') {
                showCustomAlert('Notificaciones', 'Notificaciones ya activas. Pulsa "Reprogramar hoy" para programar.');
                return;
            }
            Notification.requestPermission().then(p => {
                if (p === 'granted') {
                    showCustomAlert('Permiso Concedido', 'Perfecto. Ahora pulsa ‚ÄúReprogramar hoy‚Äù para programar las notificaciones.');
                } else {
                    showCustomAlert('Permiso Denegado', 'No podr√°s recibir notificaciones sin tu permiso.');
                }
            });
        }

        /**
         * Clears all previously scheduled setTimeout notifications.
         */
        function clearAllNotifications() {
            notificationTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
            notificationTimeouts = []; // Reset the array
        }

        /**
         * Schedules notifications for the current day's plan.
         */
        function scheduleToday() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                showCustomAlert('Atenci√≥n', 'Activa las notificaciones primero para poder programarlas.');
                return;
            }

            clearAllNotifications(); // Clear previous notifications

            const data = WEEK_PLAN[appState.day];
            const entries = data.meals
                .map(m => {
                    const mealId = `${appState.day}-${m.k}`;
                    const selectedOptionIndex = appState.selectedAlternatives[mealId] !== undefined ? appState.selectedAlternatives[mealId] : 0;
                    return { label: m.name, body: m.options[selectedOptionIndex] || '', key: m.k };
                })
                .concat([{ k: 'ent', name: 'Entreno', body: data.workout, key: 'ent' }]);

            const now = new Date();
            let programmedCount = 0;

            entries.forEach(entry => {
                const time = appState.times[entry.key] || DEFAULT_TIMES[entry.key];
                const [hours, minutes] = time.split(':').map(Number);
                const notificationTime = new Date();
                notificationTime.setHours(hours, minutes, 0, 0);

                const msUntilNotification = notificationTime - now;

                if (msUntilNotification > 0) {
                    const timeoutId = setTimeout(() => {
                        try {
                            new Notification(entry.label, { body: entry.body, icon: 'https://placehold.co/192x192/F4D00C/161616?text=LF' });
                        } catch (error) {
                            console.error('Error al mostrar notificaci√≥n:', error);
                        }
                    }, msUntilNotification);
                    notificationTimeouts.push(timeoutId);
                    programmedCount++;
                }
            });
            showCustomAlert('Notificaciones Programadas',
                programmedCount ? `Recordatorios de hoy programados: ${programmedCount}.` : 'Hoy ya han pasado todos los horarios para programar.'
            );
        }

        /**
         * Renders all UI components.
         */
        function renderAll() {
            renderTopBar();
            renderPlanList();
            renderPhysicalRecords();
            renderGoalsInputs(); // Populate goal inputs
            renderGoalsStatus(); // Show current goal status
            renderChartControls(); // Render chart controls (update their state)
            renderProgressChart(); // Render chart
            saveState();
        }

        /**
         * Renders the chart controls (dropdown and checkboxes) based on appState.
         */
        function renderChartControls() {
            DOMElements.chartTimeRange.value = appState.chartSettings.timeRange;
            DOMElements.chartShowWeight.checked = appState.chartSettings.showWeight;
            DOMElements.chartShowBodyfat.checked = appState.chartSettings.showBodyfat;
            DOMElements.chartShowWater.checked = appState.chartSettings.showWater;
            DOMElements.chartShowSteps.checked = appState.chartSettings.showSteps;
            DOMElements.chartShowSleep.checked = appState.chartSettings.showSleep;
            DOMElements.chartShowMuscle.checked = appState.chartSettings.showMuscle;
        }

        /**
         * Initializes the application.
         */
        function initApp() {
            renderAll();
            renderTimes();

            // Event Listeners
            DOMElements.btnNotif.addEventListener('click', requestNotifications);
            DOMElements.btnProgramar.addEventListener('click', scheduleToday);
            DOMElements.btnSavePhysicalRecord.addEventListener('click', savePhysicalRecord);
            DOMElements.btnSaveGoals.addEventListener('click', saveGoals); // New event listener for goals
            DOMElements.resetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showCustomConfirm('Reiniciar App', '¬øEst√°s seguro de que quieres reiniciar todo el progreso, horarios y registros? Esta acci√≥n es irreversible.', () => {
                    localStorage.clear();
                    location.reload();
                });
            });

            // Chart control event listeners
            DOMElements.chartTimeRange.addEventListener('change', (e) => {
                appState.chartSettings.timeRange = e.target.value;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowWeight.addEventListener('change', (e) => {
                appState.chartSettings.showWeight = e.target.checked;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowBodyfat.addEventListener('change', (e) => {
                appState.chartSettings.showBodyfat = e.target.checked;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowWater.addEventListener('change', (e) => {
                appState.chartSettings.showWater = e.target.checked;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowSteps.addEventListener('change', (e) => {
                appState.chartSettings.showSteps = e.target.checked;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowSleep.addEventListener('change', (e) => {
                appState.chartSettings.showSleep = e.target.checked;
                saveState();
                renderProgressChart();
            });
            DOMElements.chartShowMuscle.addEventListener('change', (e) => {
                appState.chartSettings.showMuscle = e.target.checked;
                saveState();
                renderProgressChart();
            });
        }

        // Initialize the app when the window loads
        window.onload = initApp;
    </script>
</body>
</html>
